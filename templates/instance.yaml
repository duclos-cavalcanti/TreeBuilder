resources:
- name: client
  properties:
    disks:
    - autoDelete: true
      boot: true
      deviceName: boot
      initializeParams:
        sourceImage: projects/multicast1/global/images/multicast-ubuntu-2204-ebpf
      type: PERSISTENT
    machineType: zones/us-east4-c/machineTypes/e2-standard-4
    metadata:
      items:
      - key: startup-script
        value: "#! /bin/bash\n\necho \"Starting script...\"\n\nget_metadata() {\n\
          \  curl -s http://metadata.google.internal/computeMetadata/v1/instance/attributes/$1\
          \ -H \"Metadata-Flavor: Google\"\n}\n\necho \"Fetching metadata\"\n\n# Common\
          \ Variables\nIP_ADDR=$(get_metadata IP_ADDR)\nINSTANCE_NUM=$(get_metadata\
          \ INSTANCE_NUM)\nBKT_NAME=$(get_metadata BKT_NAME)\nRUN_MODE=$(get_metadata\
          \ RUN_MODE)\nCLOUD=$(get_metadata CLOUD)\n\necho \"IP Address: $IP_ADDR\"\
          \necho \"Instance Number: $INSTANCE_NUM\"\necho \"Bucket Name: $BKT_NAME\"\
          \necho \"Run Mode: $RUN_MODE\"\necho \"Cloud: $CLOUD\"\n\necho \"Downloading\
          \ service bundle\"\ncd /home/uab2005\nsudo rm -rf dom-tenant-service/\n\
          sudo mkdir dom-tenant-service/\nsudo chmod 777 dom-tenant-service/\nsudo\
          \ chown -R root:root ./dom-tenant-service\n\ngcloud storage cp gs://cdm-templates-nyu-systems-multicast/bundled_proj.tar.gz\
          \ .\ntar -xzf bundled_proj.tar.gz -C dom-tenant-service/\nexport HOME=/root\n\
          \necho \"Deploying ttcs\"\ncd dom-tenant-service/gcp-deploy\nsudo chmod\
          \ +x ../aws-deploy/stats_to_s3.sh\nsudo chmod +x ./deploy_ttcs.sh\n# sudo\
          \ ./deploy_ttcs.sh ./assets/ttcs-agent.cfg $IP_ADDR\n\ncd ../src\n\necho\
          \ \"Compiling client\"\nmake multicast_client"
      - key: IP_ADDR
        value: 10.1.1.0
      - key: INSTANCE_NUM
        value: '0'
      - key: BKT_NAME
        value: cdm-templates-nyu-systems-multicast
      - key: RUN_MODE
        value: dpdk
      - key: CLOUD
        value: gcp
    networkInterfaces:
    - accessConfigs:
      - networkTier: PREMIUM
        type: ONE_TO_ONE_NAT
      network: projects/multicast1/global/networks/multicast-management
      networkIP: 10.1.1.0
      nicType: GVNIC
      stackType: IPV4_ONLY
      subnetwork: projects/multicast1/regions/us-east4/subnetworks/multicast-management
    - network: projects/multicast1/global/networks/multicast-service
      networkIP: 10.0.1.0
      nicType: GVNIC
      stackType: IPV4_ONLY
      subnetwork: projects/multicast1/regions/us-east4/subnetworks/multicast-service
    serviceAccounts:
    - email: multicast-service-vm@multicast1.iam.gserviceaccount.com
      scopes:
      - https://www.googleapis.com/auth/cloud-platform
    zone: us-east4-c
  type: compute.v1.instance
- name: proxy
  properties:
    disks:
    - autoDelete: true
      boot: true
      deviceName: boot
      initializeParams:
        sourceImage: projects/multicast1/global/images/multicast-ubuntu-2204-ebpf
      type: PERSISTENT
    machineType: zones/us-east4-c/machineTypes/e2-standard-4
    metadata:
      items:
      - key: startup-script
        value: "#! /bin/bash\n\necho \"Starting script...\"\n\nget_metadata() {\n\
          \  curl -s http://metadata.google.internal/computeMetadata/v1/instance/attributes/$1\
          \ -H \"Metadata-Flavor: Google\"\n}\n\necho \"Fetching metadata\"\n\n# Common\
          \ Variables\nIP_ADDR=$(get_metadata IP_ADDR)\nINSTANCE_NUM=$(get_metadata\
          \ INSTANCE_NUM)\nBKT_NAME=$(get_metadata BKT_NAME)\nRUN_MODE=$(get_metadata\
          \ RUN_MODE)\nCLOUD=$(get_metadata CLOUD)\n\necho \"IP Address: $IP_ADDR\"\
          \necho \"Instance Number: $INSTANCE_NUM\"\necho \"Bucket Name: $BKT_NAME\"\
          \necho \"Run Mode: $RUN_MODE\"\necho \"Cloud: $CLOUD\"\n\n# Variables for\
          \ branching VMs\nBRANCHING_FACTOR=$(get_metadata BRANCHING_FACTOR)\nREDUNDANCY_FACTOR=$(get_metadata\
          \ REDUNDANCY_FACTOR)\nTOTAL_NON_REDUNDANT_PROXIES=$(get_metadata TOTAL_NON_REDUNDANT_PROXIES)\n\
          DUPLICATION_FACTOR=$(get_metadata DUPLICATION_FACTOR)\n\necho \"Branching\
          \ Factor: $BRANCHING_FACTOR\"\necho \"Redundancy Factor: $REDUNDANCY_FACTOR\"\
          \necho \"Total Non-redundant Proxies: $TOTAL_NON_REDUNDANT_PROXIES\"\necho\
          \ \"Duplication Factor: $DUPLICATION_FACTOR\"\n\necho \"Downloading service\
          \ bundle\"\ncd /home/uab2005\nsudo rm -rf dom-tenant-service/\nsudo mkdir\
          \ dom-tenant-service/\nsudo chmod 777 dom-tenant-service/\nsudo chown -R\
          \ root:root ./dom-tenant-service\n\ngcloud storage cp gs://cdm-templates-nyu-systems-multicast/bundled_proj.tar.gz\
          \ .\ntar -xzf bundled_proj.tar.gz -C dom-tenant-service/\nexport HOME=/root\n\
          \necho \"Starting DPDK for ens5 and saving ens4 information\"\ncat /sys/class/net/ens5/address\
          \ > mac.txt\ncat /sys/class/net/ens4/address > macsocket.txt\nip -o -4 addr\
          \ show dev ens5 | cut -d' ' -f7 | cut -d'/' -f1 > ip.txt\nip -o -4 addr\
          \ show dev ens4 | cut -d' ' -f7 | cut -d'/' -f1 > ipsocket.txt\nsudo modprobe\
          \ igb_uio\nip link set dev ens5 down\nsysctl -w vm.nr_hugepages=5000\nsudo\
          \ dpdk-devbind.py --bind=igb_uio 00:05.0\nsudo dpdk-devbind.py --status\n\
          \necho \"Deploying ttcs\"\ncd dom-tenant-service/gcp-deploy\nsudo chmod\
          \ +x ./deploy_ttcs.sh\n# sudo ./deploy_ttcs.sh ./assets/ttcs-agent.cfg $IP_ADDR\n\
          \ncd ..\nsudo tc qdisc add dev ens4 clsact\ncp ./../mac.txt ./config/mac.txt\n\
          cp ./../macsocket.txt ./config/macsocket.txt\ncp ./../ip.txt ./config/ip.txt\n\
          cp ./../ipsocket.txt ./config/ipsocket.txt\ncd ./src\n\necho \"Compiling\
          \ proxy\"\nclang -g -O2 -Wall -target bpf -I ~/iproute2/include/ -c ./multicast_proxy/tc-replication.c\
          \ -o tc-replication.o\nmake multicast_proxy\n\necho \"Starting proxy\"\n\
          ./build/multicast_proxy $INSTANCE_NUM $BRANCHING_FACTOR $RUN_MODE $REDUNDANCY_FACTOR\
          \ $TOTAL_NON_REDUNDANT_PROXIES $CLOUD\n"
      - key: IP_ADDR
        value: 10.1.2.0
      - key: INSTANCE_NUM
        value: '0'
      - key: BKT_NAME
        value: cdm-templates-nyu-systems-multicast
      - key: RUN_MODE
        value: dpdk
      - key: CLOUD
        value: gcp
      - key: BRANCHING_FACTOR
        value: '2'
      - key: REDUNDANCY_FACTOR
        value: '0'
      - key: TOTAL_NON_REDUNDANT_PROXIES
        value: '3'
      - key: DUPLICATION_FACTOR
        value: '1'
    networkInterfaces:
    - accessConfigs:
      - networkTier: PREMIUM
        type: ONE_TO_ONE_NAT
      network: projects/multicast1/global/networks/multicast-management
      networkIP: 10.1.2.0
      nicType: GVNIC
      stackType: IPV4_ONLY
      subnetwork: projects/multicast1/regions/us-east4/subnetworks/multicast-management
    - network: projects/multicast1/global/networks/multicast-service
      networkIP: 10.0.2.0
      nicType: GVNIC
      stackType: IPV4_ONLY
      subnetwork: projects/multicast1/regions/us-east4/subnetworks/multicast-service
    serviceAccounts:
    - email: multicast-service-vm@multicast1.iam.gserviceaccount.com
      scopes:
      - https://www.googleapis.com/auth/cloud-platform
    zone: us-east4-c
  type: compute.v1.instance
- name: recipient
  properties:
    disks:
    - autoDelete: true
      boot: true
      deviceName: boot
      initializeParams:
        sourceImage: projects/multicast1/global/images/multicast-ubuntu-2204-ebpf
      type: PERSISTENT
    machineType: zones/us-east4-c/machineTypes/e2-standard-4
    metadata:
      items:
      - key: startup-script
        value: "#! /bin/bash\n\necho \"Starting script...\"\n\nget_metadata() {\n\
          \  curl -s http://metadata.google.internal/computeMetadata/v1/instance/attributes/$1\
          \ -H \"Metadata-Flavor: Google\"\n}\n\necho \"Fetching metadata\"\n\n# Common\
          \ Variables\nIP_ADDR=$(get_metadata IP_ADDR)\nINSTANCE_NUM=$(get_metadata\
          \ INSTANCE_NUM)\nBKT_NAME=$(get_metadata BKT_NAME)\nRUN_MODE=$(get_metadata\
          \ RUN_MODE)\nCLOUD=$(get_metadata CLOUD)\n\necho \"IP Address: $IP_ADDR\"\
          \necho \"Instance Number: $INSTANCE_NUM\"\necho \"Bucket Name: $BKT_NAME\"\
          \necho \"Run Mode: $RUN_MODE\"\necho \"Cloud: $CLOUD\"\n\n# Variables for\
          \ branching VMs\nBRANCHING_FACTOR=$(get_metadata BRANCHING_FACTOR)\nREDUNDANCY_FACTOR=$(get_metadata\
          \ REDUNDANCY_FACTOR)\nTOTAL_NON_REDUNDANT_PROXIES=$(get_metadata TOTAL_NON_REDUNDANT_PROXIES)\n\
          DUPLICATION_FACTOR=$(get_metadata DUPLICATION_FACTOR)\n\necho \"Branching\
          \ Factor: $BRANCHING_FACTOR\"\necho \"Redundancy Factor: $REDUNDANCY_FACTOR\"\
          \necho \"Total Non-redundant Proxies: $TOTAL_NON_REDUNDANT_PROXIES\"\necho\
          \ \"Duplication Factor: $DUPLICATION_FACTOR\"\n\necho \"Downloading service\
          \ bundle\"\ncd /home/uab2005\nsudo rm -rf dom-tenant-service/\nsudo mkdir\
          \ dom-tenant-service/\nsudo chmod 777 dom-tenant-service/\nsudo chown -R\
          \ root:root ./dom-tenant-service\n\ngcloud storage cp gs://cdm-templates-nyu-systems-multicast/bundled_proj.tar.gz\
          \ .\ntar -xzf bundled_proj.tar.gz -C dom-tenant-service/\nexport HOME=/root\n\
          \necho \"Starting DPDK for ens5 and saving ens4 information\"\ncat /sys/class/net/ens5/address\
          \ > mac.txt\ncat /sys/class/net/ens4/address > macsocket.txt\nip -o -4 addr\
          \ show dev ens5 | cut -d' ' -f7 | cut -d'/' -f1 > ip.txt\nip -o -4 addr\
          \ show dev ens4 | cut -d' ' -f7 | cut -d'/' -f1 > ipsocket.txt\nsudo modprobe\
          \ igb_uio\nip link set dev ens5 down\nsysctl -w vm.nr_hugepages=5000\nsudo\
          \ dpdk-devbind.py --bind=igb_uio 00:05.0\nsudo dpdk-devbind.py --status\n\
          \necho \"Deploying ttcs\"\ncd dom-tenant-service/gcp-deploy\nsudo chmod\
          \ +x ../aws-deploy/stats_to_s3.sh\nsudo chmod +x ./deploy_ttcs.sh\n# sudo\
          \ ./deploy_ttcs.sh ./assets/ttcs-agent.cfg $IP_ADDR\n\ncd ..\ncp ./../mac.txt\
          \ ./config/mac.txt\ncp ./../macsocket.txt ./config/macsocket.txt\ncp ./../ip.txt\
          \ ./config/ip.txt\ncp ./../ipsocket.txt ./config/ipsocket.txt\ncd ./src\n\
          \necho \"Compiling receiver\"\nmake multicast_receivers\n\necho \"Starting\
          \ receiver\"\necho \"./build/multicast_receivers $INSTANCE_NUM $DUPLICATION_FACTOR\
          \ $RUN_MODE $BRANCHING_FACTOR $REDUNDANCY_FACTOR $TOTAL_NON_REDUNDANT_PROXIES\
          \ $CLOUD\"\n# ./build/multicast_receivers $INSTANCE_NUM $DUPLICATION_FACTOR\
          \ $RUN_MODE $BRANCHING_FACTOR $REDUNDANCY_FACTOR $TOTAL_NON_REDUNDANT_PROXIES\
          \ $CLOUD\n\n"
      - key: IP_ADDR
        value: 10.1.3.0
      - key: INSTANCE_NUM
        value: '0'
      - key: BKT_NAME
        value: cdm-templates-nyu-systems-multicast
      - key: RUN_MODE
        value: dpdk
      - key: CLOUD
        value: gcp
      - key: BRANCHING_FACTOR
        value: '2'
      - key: REDUNDANCY_FACTOR
        value: '0'
      - key: TOTAL_NON_REDUNDANT_PROXIES
        value: '3'
      - key: DUPLICATION_FACTOR
        value: '1'
    networkInterfaces:
    - accessConfigs:
      - networkTier: PREMIUM
        type: ONE_TO_ONE_NAT
      network: projects/multicast1/global/networks/multicast-management
      networkIP: 10.1.3.0
      nicType: GVNIC
      stackType: IPV4_ONLY
      subnetwork: projects/multicast1/regions/us-east4/subnetworks/multicast-management
    - network: projects/multicast1/global/networks/multicast-service
      networkIP: 10.0.3.0
      nicType: GVNIC
      stackType: IPV4_ONLY
      subnetwork: projects/multicast1/regions/us-east4/subnetworks/multicast-service
    serviceAccounts:
    - email: multicast-service-vm@multicast1.iam.gserviceaccount.com
      scopes:
      - https://www.googleapis.com/auth/cloud-platform
    zone: us-east4-c
  type: compute.v1.instance
